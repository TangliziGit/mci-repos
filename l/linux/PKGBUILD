# Maintainer: Jan Alexander Steffens (heftig) <heftig@archlinux.org>
pkgname=linux
pkgbase=linux
pkgver=6.2.0
pkgrel=1
pkgdesc='Linux'
url="https://github.com/archlinux/linux"
arch=(x86_64)
license=(GPL2)

# NOTE: prepare function is called after pkgver in makepkg v4.2.0
_download_source() {
  [[ -d "linux" ]] && return
  # retry git clone
  for i in $(seq 1 5); do
    git clone --depth 1 "$url" 2>&1 && break
  done

  cd linux
  wget -q https://raw.githubusercontents.com/archlinux/svntogit-packages/packages/linux/trunk/config -O .config
  make olddefconfig 2>&1
  scripts/config --file .config --disable CONFIG_UNUSED_SYMBOLS
  scripts/config --file .config --enable CONFIG_TRIM_UNUSED_KSYMS
  scripts/config --file .config --disable CONFIG_MODULE_COMPRESS_ZSTD
  scripts/config --file .config --enable CONFIG_MODULE_COMPRESS_XZ
}

prepare() {
  cd $srcdir
  _download_source
}

pkgver() {
  cd $srcdir
  _download_source 1>/dev/null

  cd $srcdir/linux
  make -s kernelrelease > version
  version="$(<"$srcdir/linux/version")"
  echo "${version%%-*}"
}

build() {
  cd "$srcdir/linux"
  echo "Building $pkgbase version $(<version)"
  make -j 8 all
}

package() {
  cd "$srcdir/linux"

  make INSTALL_MOD_PATH="$pkgdir/" INSTALL_MOD_STRIP=1 modules_install
  modulesdir="$pkgdir/lib/modules/$(<version)"
  rm "$modulesdir"/{source,build}

  mkdir -p "$pkgdir/boot"
  make -s image_name >"$pkgdir/boot/image_name"
  cp "$(make -s image_name)" "$pkgdir/boot/vmlinuz-$(<version)"
  cp "vmlinux" "$pkgdir/boot/vmlinux-$(<version)"
  cp "arch/x86/boot/bzImage" "$pkgdir/boot/bzImage-$(<version)"
  cp "arch/x86/boot/compressed/vmlinux" "$pkgdir/boot/compressed-vmlinux-$(<version)"
  cp "arch/x86/boot/compressed/vmlinux.bin" "$pkgdir/boot/compressed-vmlinux-bin-$(<version)"
  cp "arch/x86/boot/compressed/vmlinux.bin.zst" "$pkgdir/boot/compressed-vmlinux-bin-zstd-$(<version)"
}
